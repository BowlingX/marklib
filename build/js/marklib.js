!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.Marklib=t():e.Marklib=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var a=n[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";var r=n(2)["default"],a=r(n(1));e.exports=a},function(e,t,n){"use strict";var r=n(3)["default"],a=n(4)["default"],i=n(2)["default"],o=n(5),s=i(o),u=o.ATTR_DATA_ORIGINAL_INDEX,l=o.DATA_IS_SELECTION,d="x-marker",f="data-original-offset-start",c="original-text-node-index",h="data-is-start-end",p="data-is-highlight-node",v="data-selection-id",_=function(){function e(t,n,a){if(r(this,e),!(t instanceof Document))throw"Marklib {0} is required to be a document instance";this.document=t,this.id=s.guid(),this.cssClass=n||"marking",this.startContainer=null,this.endContainer=null,this.markerPrefix="marker-start-",this.markerSuffix="marker-end-",this.context=a||this.document}return a(e,{getId:{value:function(){return this.id}},setId:{value:function(e){return this.id=e,this}},_createWrapTemplate:{value:function(){var e=this.document.createElement(d),t="true";return e.className=this.cssClass,e.setAttribute(l,t),e.setAttribute(v,this.getId()),e.setAttribute(p,t),e}},_createStartEndWrapTemplate:{value:function(e,t){var n=this._createWrapTemplate(),r="true";return n.setAttribute(h,r),n.id=e,n.textContent=t,n}},_createStartOrEndContainer:{value:function(t,n,r,a,i){var o=this._createStartEndWrapTemplate(n+this.getId(),r);return o.setAttribute(u,e._getIndexParentIfHas(t,i)),o.setAttribute(f,a),o.setAttribute(c,i),o.marklibInstance=this,o}},_createWrap:{value:function(t,n,r,a){var i=r>=0?r:s.calcIndex(t),o=this._createWrapTemplate();o.setAttribute(u,e._getIndexParentIfHas(t,i));var l=n>=0?n:e._getOffsetParentIfHas(t);return o.setAttribute(f,l),o.setAttribute(c,i),o.marklibInstance=this,a&&o.setAttribute(h,h),s.wrap(t,o)}},_createSplitContainer:{value:function(t,n,r){var a=this.document.createElement(d),i="true";return a.setAttribute(l,i),a.setAttribute(u,e._getIndexParentIfHas(t,n)),a.setAttribute(f,r),a.setAttribute(c,n),a}},_walkTextNodes:{value:function(e,t){this.walkDom(e,function(e){return Node.TEXT_NODE!==e.nodeType||s.nodeIsEmpty(e)||t(e),!0})}},walk:{value:function(e,t,n){for(var r=e;r&&r!==n.parentNode;){var a=r;if(r=r.parentNode,this.wrapSiblings(a.nextSibling,t))break}}},wrapSiblings:{value:function(e,t){for(var n=this,r=e,a=!1,i=function(e){if(e.parentNode.hasAttribute(h)&&e.parentNode.hasAttribute(p)&&e.parentNode.getAttribute(v)==n.getId()){var t=n._createWrap(e).parentNode;t.classList.remove(n.cssClass),t.removeAttribute(p)}else n._createWrap(e)}.bind(this),o=function(e){s.nodeIsEmpty(e)||i(e)};null!==r&&r!==t;){var u=r;if(r=r.nextSibling,Node.TEXT_NODE===u.nodeType)o(u);else if(u.contains(t)?(this.walkDom(u,function(e){return e===t?!1:(Node.TEXT_NODE===e.nodeType&&o(e),!0)}),a=!0):this._walkTextNodes(u,function(e){o(e)}),a)return!0}return a}},walkDom:{value:function(e,t){if(!e)return!1;var n=e.childNodes;if(!n)return!1;for(var r=0;r<n.length;r++)if(!this.walkDom(n[r],t))return!1;return t(e)}},_markTextSameNode:{value:function(t,n,r){var a=t.nodeValue,i=s.calcIndex(t);if(!a)return!1;if(n>0){var o=a.slice(0,n);t.parentNode.insertBefore(new Text(o),t),s.wrap(t.previousSibling,this._createSplitContainer(t,i,e._getOffsetParentIfHas(t)))}if(r<a.length){var u=a.slice(r,a.length);t.parentNode.insertBefore(new Text(u),t.nextSibling),s.wrap(t.nextSibling,this._createSplitContainer(t,i,e._getOffsetParentIfHas(t)+r))}return t.nodeValue=a.slice(n,r),this.startContainer=this._createWrap(t,e._getOffsetParentIfHas(t)+n,i,!0).parentNode,this.endContainer=this.startContainer,this.startContainer}},_markTextDifferentNode:{value:function(t,n,r,a){var i=s.calcIndex(t),o=s.calcIndex(n),u=t.nodeValue,l=t;if(void 0!==u){var d=u.slice(r,u.length);t.nodeValue=u.slice(0,r);var f=e._getOffsetParentIfHas(t);l=this._createStartOrEndContainer(t,this.markerPrefix,d,f===r?f:f+r,i),t.parentNode.insertBefore(l,t.nextSibling),this.startContainer=l,t.nodeValue&&s.wrap(t,this._createSplitContainer(t,i,e._getOffsetParentIfHas(t)))}var c=n,h=n.nodeValue;if(void 0!==h){var p=h.slice(0,a);n.nodeValue=h.slice(a,h.length),c=this._createStartOrEndContainer(n,this.markerSuffix,p,e._getOffsetParentIfHas(n),o),n.parentNode.insertBefore(c,n),this.endContainer=c;var v=e._getOffsetParentIfHas(n);s.wrap(n,this._createSplitContainer(n,o,v===a?v:v+a))}return{startT:l,endT:c}}},_findOriginalOffset:{value:function(e){if(!e.parentNode.hasAttribute(f))return 0;var t=s.parent(e,"["+f+"]");return t?parseInt(t.getAttribute(f)):0}},_renderWithElements:{value:function(e,t,n,r,a){var i=s.parents(e,n);i=i[i.length-1];var o=i?i:n,u=this._findOriginalOffset(e),d=this._findOriginalOffset(t);if(e.nodeType!==Node.TEXT_NODE&&t.nodeType!==Node.TEXT_NODE&&e===t&&(t=t.nextElementSibling||t),e.nodeType!==Node.TEXT_NODE&&this.walkDom(e,function(t){return t.nodeType===Node.TEXT_NODE?(e=t,!1):!0}),t.nodeType!==Node.TEXT_NODE){var c=s.closest(e,":not(["+l+"])").childNodes;if(c.length){var h=c[c.length-1];if(h.nodeType===Node.TEXT_NODE)t=h,a=h.length;else for(var p=h.lastChild;null!==p;)p&&p.nodeType===Node.TEXT_NODE&&(t=p,a=p.length,p.parentNode.hasAttribute(f)&&(a=parseInt(p.parentNode.getAttribute(f))+a)),p=p.lastChild}if(t.nodeType!==Node.TEXT_NODE)throw"Could not found endContainer, highlighting would be unstable"}var v={startOffset:u+r,endOffset:d+a,startContainerPath:s.getPath(e,this.context),endContainerPath:s.getPath(t,this.context)};return this._renderSelection(e,t,r,a,o,i),v}},_renderSelection:{value:function(e,t,n,r,a,i){if(e===t)this._markTextSameNode(e,n,r);else{var o=this._markTextDifferentNode(e,t,n,r);i?this.walk(o.startT,t,a):this.wrapSiblings(o.startT.nextSibling,t)}}},_deserializePath:{value:function(e){var t=e.split(";"),n=t[0],r=parseInt(t[1]),a=parseInt(t[2]),i=this.context.querySelector(n),o=null;return this.walkDom(i,function(e){if(e.nodeType!==Node.TEXT_NODE)return!0;var t=e.parentNode.getAttribute(f);t=null===t?0:t;var n=e.parentNode.getAttribute(u);if(n=null===n?s.calcIndex(e):n,n==r&&a>=t&&parseInt(t)+e.length>=a){var i=e.parentNode.hasAttribute(f)?a-parseInt(e.parentNode.getAttribute(f)):a;return o={node:e,offset:i},!1}return!0}),o}},renderWithPath:{value:function(e,t){var n=this._deserializePath(e),r=this._deserializePath(t);if(n&&r&&n.node&&r.node){var a=document.createRange();return a.setStart(n.node,n.offset),a.setEnd(r.node,r.offset),this.renderWithRange(a),a}throw"Could not find start- and/or end-container in document"}},renderWithRange:{value:function(e){return this._renderWithElements(e.startContainer,e.endContainer,e.commonAncestorContainer,e.startOffset,e.endOffset)}}},{_getParentIfHas:{value:function(e,t,n){var r=e.parentNode,a=parseInt(r.getAttribute(n));return a>t?a:t}},_getIndexParentIfHas:{value:function(t,n){return e._getParentIfHas(t,n,u)}},_getOffsetParentIfHas:{value:function(t){return e._getParentIfHas(t,f)}}}),e}();e.exports=_},function(e,t){"use strict";t["default"]=function(e){return e&&e.__esModule?e["default"]:e},t.__esModule=!0},function(e,t){"use strict";t["default"]=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.__esModule=!0},function(e,t){"use strict";t["default"]=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),t.__esModule=!0},function(e,t,n){"use strict";var r=n(3)["default"],a=n(4)["default"];Object.defineProperty(t,"__esModule",{value:!0});var i="data-original-index";t.ATTR_DATA_ORIGINAL_INDEX=i;var o="data-is-pseudo";t.DATA_PSEUDO=o;var s="data-is-selection";t.DATA_IS_SELECTION=s;var u=";",l=function(){function e(){r(this,e)}return a(e,null,{nodeListFilter:{value:function(e,t){return Array.prototype.filter.call(e||[],t)}},guid:{value:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}},nodeIsEmpty:{value:function(e){return e.nodeValue.match(/^[\s]*$/g)}},index:{value:function(e,t){var n=t||(e.nodeType===Node.TEXT_NODE?e.parentNode.childNodes:e.parentNode.children);return Array.prototype.indexOf.call(n||[],e)}},wrap:{value:function(e,t){e instanceof NodeList||e instanceof Array||(e=[e]);for(var n=e.length-1;n>=0;n--){var r=n>0?t.cloneNode(!0):t,a=e[n],i=a.parentNode,o=a.nextSibling;r.appendChild(a),o?i.insertBefore(r,o):i.appendChild(r)}return t}},calcIndex:{value:function(t){for(var n=0,r=!1,a=t.childNodes,s=a.length,u=0;s>u;u++){var l=a[u];if(l===t)return!1;var d=l.getAttribute(i),f=void 0!==d;l===t||l.nodeType===Node.TEXT_NODE&&!f||l.hasAttribute(o)||(f?(n=parseInt(d),r=!0):n++)}return r?n:e.index(t)}},parents:{value:function(e,t){for(var n=e,r=[];null!==n.parentNode;)n=n.parentNode,t&&(n===t||"string"==typeof t&&n.matches&&n.matches(t))?r.push(n):t||r.push(n);return r}},parent:{value:function(e,t){for(var n=e;null!==n.parentNode;)if(n=n.parentNode,n.matches&&n.matches(t))return n;return!1}},closest:{value:function(e,t){for(var n=e;null!==n;){if(n.matches&&n.matches(t))return n;n=n.parentNode}return!1}},getPath:{value:function(t,n){for(var r=null,a=t;a;){var o=null;if(Node.TEXT_NODE===a.nodeType){var l=e.parents(a,"["+i+"]").reverse()[0],d=0;l||(d=e.calcIndex(a));var f=l?parseInt(l.getAttribute(i)):d;o=u+f}else o=a.nodeName;if(!o)break;o=o.toLowerCase();var c=a.parentNode;if(a instanceof HTMLElement&&a.hasAttribute(s))a=c;else{var h=e.nodeListFilter(c.children,function(e){return!e.hasAttribute(s)&&e.nodeName===a.nodeName}),p=e.index(a,h);if(h.length>1&&p>=0&&(o+=":nth-of-type("+(p+1)+")"),r=o+(r?">"+r:""),c===n)break;a=c}}return r.replace("#document>","").replace(">;",";")}}}),e}();t["default"]=l}])});
//# sourceMappingURL=marklib.map